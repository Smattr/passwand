language: c

matrix:
  include:
  - name: Ubuntu Linux 20.04, GCC 7, no GTK
    os: linux
    dist: focal
    addons:
      apt:
        packages:
          - gcc-7
          # we need to install libscrypt-kdf1 explicitly
          # https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=962425
          - libscrypt-kdf1
          - libscrypt-kdf-dev
          - pylint
    env:
      - CFLAGS="-g -Werror"
      - GTK=
      - TARGETS="pw-cli pw-gui-test-stub"
      - MATRIX_EVAL="CC=gcc-7"
  - name: Ubuntu Linux 20.04, GCC 7, GTK 2
    os: linux
    dist: focal
    addons:
      apt:
        packages:
          - gcc-7
          - libscrypt-kdf1
          - libscrypt-kdf-dev
          - pylint
    env:
      # XXX: we need to disable -Wdeprecated-declarations because the GTK 2
      # headers trigger this
      - CFLAGS="-g -Werror -Wno-deprecated-declarations"
      - GTK=libgtk2.0-dev
      - TARGETS="pw-cli pw-gui-test-stub pw-gui"
      - MATRIX_EVAL="CC=gcc-7"
  - name: Ubuntu Linux 20.04, GCC 7, GTK 3
    os: linux
    dist: focal
    addons:
      apt:
        packages:
          - gcc-7
          - libscrypt-kdf1
          - libscrypt-kdf-dev
          - pylint
    env:
      - CFLAGS="-g -Werror"
      - GTK=libgtk-3-dev
      - TARGETS="pw-cli pw-gui-test-stub pw-gui"
      - MATRIX_EVAL="CC=gcc-7"
  - name: Ubuntu Linux 20.04, GCC 8, no GTK
    os: linux
    dist: focal
    addons:
      apt:
        packages:
          - gcc-8
          - libscrypt-kdf1
          - libscrypt-kdf-dev
          - pylint
    env:
      - CFLAGS="-g -Werror"
      - GTK=
      - TARGETS="pw-cli pw-gui-test-stub"
      - MATRIX_EVAL="CC=gcc-8"
  - name: Ubuntu Linux 20.04, GCC 8, GTK 2
    os: linux
    dist: focal
    addons:
      apt:
        packages:
          - gcc-8
          - libscrypt-kdf1
          - libscrypt-kdf-dev
          - pylint
    env:
      - CFLAGS="-g -Werror -Wno-deprecated-declarations"
      - GTK=libgtk2.0-dev
      - TARGETS="pw-cli pw-gui-test-stub pw-gui"
      - MATRIX_EVAL="CC=gcc-8"
  - name: Ubuntu Linux 20.04, GCC 8, GTK 3
    os: linux
    dist: focal
    addons:
      apt:
        packages:
          - gcc-8
          - libscrypt-kdf1
          - libscrypt-kdf-dev
          - pylint
    env:
      - CFLAGS="-g -Werror"
      - GTK=libgtk-3-dev
      - TARGETS="pw-cli pw-gui-test-stub pw-gui"
      - MATRIX_EVAL="CC=gcc-8"
  - name: Ubuntu Linux 20.04, GCC 9, no GTK
    os: linux
    dist: focal
    addons:
      apt:
        packages:
          - gcc-9
          - libscrypt-kdf1
          - libscrypt-kdf-dev
          - pylint
    env:
      - CFLAGS="-g -Werror"
      - GTK=
      - TARGETS="pw-cli pw-gui-test-stub"
      - MATRIX_EVAL="CC=gcc-9"
  - name: Ubuntu Linux 20.04, GCC 9, GTK 2
    os: linux
    dist: focal
    addons:
      apt:
        packages:
          - gcc-9
          - libscrypt-kdf1
          - libscrypt-kdf-dev
          - pylint
    env:
      - CFLAGS="-g -Werror -Wno-deprecated-declarations"
      - GTK=libgtk2.0-dev
      - TARGETS="pw-cli pw-gui-test-stub pw-gui"
      - MATRIX_EVAL="CC=gcc-9"
  - name: Ubuntu Linux 20.04, GCC 9, GTK 3
    os: linux
    dist: focal
    addons:
      apt:
        packages:
          - gcc-9
          - libscrypt-kdf1
          - libscrypt-kdf-dev
          - pylint
    env:
      - CFLAGS="-g -Werror"
      - GTK=libgtk-3-dev
      - TARGETS="pw-cli pw-gui-test-stub pw-gui"
      - MATRIX_EVAL="CC=gcc-9"
  - name: Ubuntu Linux 20.04, GCC 10, no GTK, ASan, UBSan
    os: linux
    dist: focal
    addons:
      apt:
        packages:
          - gcc-10
          - libscrypt-kdf1
          - libscrypt-kdf-dev
          - pylint
    env:
      - CFLAGS="-g -fsanitize=address,undefined -fno-sanitize-recover=address,undefined -Werror"
      - GTK=
      - TARGETS="pw-cli pw-gui-test-stub"
      - MATRIX_EVAL="CC=gcc-10"
      - UBSAN_OPTIONS=print_stacktrace=1
  - name: Ubuntu Linux 20.04, GCC 10, GTK 2, ASan, UBSan
    os: linux
    dist: focal
    addons:
      apt:
        packages:
          - gcc-10
          - libscrypt-kdf1
          - libscrypt-kdf-dev
          - pylint
    env:
      - CFLAGS="-g -fsanitize=address,undefined -fno-sanitize-recover=address,undefined -Werror -Wno-deprecated-declarations"
      - GTK=libgtk2.0-dev
      - TARGETS="pw-cli pw-gui-test-stub pw-gui"
      - MATRIX_EVAL="CC=gcc-10"
      - UBSAN_OPTIONS=print_stacktrace=1
  - name: Ubuntu Linux 20.04, GCC 10, GTK 3, ASan, UBSan
    os: linux
    dist: focal
    addons:
      apt:
        packages:
          - gcc-10
          - libscrypt-kdf1
          - libscrypt-kdf-dev
          - pylint
    env:
      - CFLAGS="-g -fsanitize=address,undefined -fno-sanitize-recover=address,undefined -Werror"
      - GTK=libgtk-3-dev
      - TARGETS="pw-cli pw-gui-test-stub pw-gui"
      - MATRIX_EVAL="CC=gcc-10"
      - UBSAN_OPTIONS=print_stacktrace=1
  - name: Ubuntu Linux 20.04, Clang 6.0, no GTK
    os: linux
    dist: focal
    addons:
      apt:
        packages:
          - clang-6.0
          - libscrypt-kdf1
          - libscrypt-kdf-dev
          - pylint
    env:
      - CFLAGS="-g -Werror"
      - GTK=
      - TARGETS="pw-cli pw-gui-test-stub"
      - MATRIX_EVAL="CC=clang-6.0"
  - name: Ubuntu Linux 20.04, Clang 6.0, GTK 2
    os: linux
    dist: focal
    addons:
      apt:
        packages:
          - clang-6.0
          - libscrypt-kdf1
          - libscrypt-kdf-dev
          - pylint
    env:
      - CFLAGS="-g -Werror -Wno-deprecated-declarations"
      - GTK=libgtk2.0-dev
      - TARGETS="pw-cli pw-gui-test-stub pw-gui"
      - MATRIX_EVAL="CC=clang-6.0"
  - name: Ubuntu Linux 20.04, Clang 6.0, GTK 3
    os: linux
    dist: focal
    addons:
      apt:
        packages:
          - clang-6.0
          - libscrypt-kdf1
          - libscrypt-kdf-dev
          - pylint
    env:
      - CFLAGS="-g -Werror"
      - GTK=libgtk-3-dev
      - TARGETS="pw-cli pw-gui-test-stub pw-gui"
      - MATRIX_EVAL="CC=clang-6.0"
  - name: Ubuntu Linux 20.04, Clang 7, no GTK
    os: linux
    dist: focal
    addons:
      apt:
        packages:
          - clang-7
          - libscrypt-kdf1
          - libscrypt-kdf-dev
          - pylint
    env:
      - CFLAGS="-g -Werror"
      - GTK=
      - TARGETS="pw-cli pw-gui-test-stub"
      - MATRIX_EVAL="CC=clang-7"
  - name: Ubuntu Linux 20.04, Clang 7, GTK 2
    os: linux
    dist: focal
    addons:
      apt:
        packages:
          - clang-7
          - libscrypt-kdf1
          - libscrypt-kdf-dev
          - pylint
    env:
      - CFLAGS="-g -Werror -Wno-deprecated-declarations"
      - GTK=libgtk2.0-dev
      - TARGETS="pw-cli pw-gui-test-stub pw-gui"
      - MATRIX_EVAL="CC=clang-7"
  - name: Ubuntu Linux 20.04, Clang 7, GTK 3
    os: linux
    dist: focal
    addons:
      apt:
        packages:
          - clang-7
          - libscrypt-kdf1
          - libscrypt-kdf-dev
          - pylint
    env:
      - CFLAGS="-g -Werror"
      - GTK=libgtk-3-dev
      - TARGETS="pw-cli pw-gui-test-stub pw-gui"
      - MATRIX_EVAL="CC=clang-7"
  - name: Ubuntu Linux 20.04, Clang 8, no GTK
    os: linux
    dist: focal
    addons:
      apt:
        packages:
          - clang-8
          - libscrypt-kdf1
          - libscrypt-kdf-dev
          - pylint
    env:
      - CFLAGS="-g -Werror"
      - GTK=
      - TARGETS="pw-cli pw-gui-test-stub"
      - MATRIX_EVAL="CC=clang-8"
  - name: Ubuntu Linux 20.04, Clang 8, GTK 2
    os: linux
    dist: focal
    addons:
      apt:
        packages:
          - clang-8
          - libscrypt-kdf1
          - libscrypt-kdf-dev
          - pylint
    env:
      - CFLAGS="-g -Werror -Wno-deprecated-declarations"
      - GTK=libgtk2.0-dev
      - TARGETS="pw-cli pw-gui-test-stub pw-gui"
      - MATRIX_EVAL="CC=clang-8"
  - name: Ubuntu Linux 20.04, Clang 8, GTK 3
    os: linux
    dist: focal
    addons:
      apt:
        packages:
          - clang-8
          - libscrypt-kdf1
          - libscrypt-kdf-dev
          - pylint
    env:
      - CFLAGS="-g -Werror"
      - GTK=libgtk-3-dev
      - TARGETS="pw-cli pw-gui-test-stub pw-gui"
      - MATRIX_EVAL="CC=clang-8"
  - name: Ubuntu Linux 20.04, Clang 9, no GTK
    os: linux
    dist: focal
    addons:
      apt:
        packages:
          - clang-9
          - libscrypt-kdf1
          - libscrypt-kdf-dev
          - pylint
    env:
      - CFLAGS="-g -Werror"
      - GTK=
      - TARGETS="pw-cli pw-gui-test-stub"
      - MATRIX_EVAL="CC=clang-9"
  - name: Ubuntu Linux 20.04, Clang 9, GTK 2
    os: linux
    dist: focal
    addons:
      apt:
        packages:
          - clang-9
          - libscrypt-kdf1
          - libscrypt-kdf-dev
          - pylint
    env:
      - CFLAGS="-g -Werror -Wno-deprecated-declarations"
      - GTK=libgtk2.0-dev
      - TARGETS="pw-cli pw-gui-test-stub pw-gui"
      - MATRIX_EVAL="CC=clang-9"
  - name: Ubuntu Linux 20.04, Clang 9, GTK 3
    os: linux
    dist: focal
    addons:
      apt:
        packages:
          - clang-9
          - libscrypt-kdf1
          - libscrypt-kdf-dev
          - pylint
    env:
      - CFLAGS="-g -Werror"
      - GTK=libgtk-3-dev
      - TARGETS="pw-cli pw-gui-test-stub pw-gui"
      - MATRIX_EVAL="CC=clang-9"
  - name: Ubuntu Linux 20.04, Clang 10, no GTK
    os: linux
    dist: focal
    addons:
      apt:
        packages:
          - clang-10
          - libscrypt-kdf1
          - libscrypt-kdf-dev
          - pylint
    env:
      - CFLAGS="-g -Werror"
      - GTK=
      - TARGETS="pw-cli pw-gui-test-stub"
      - MATRIX_EVAL="CC=clang-10"
  - name: Ubuntu Linux 20.04, Clang 10, GTK 2
    os: linux
    dist: focal
    addons:
      apt:
        packages:
          - clang-10
          - libscrypt-kdf1
          - libscrypt-kdf-dev
          - pylint
    env:
      - CFLAGS="-g -Werror -Wno-deprecated-declarations"
      - GTK=libgtk2.0-dev
      - TARGETS="pw-cli pw-gui-test-stub pw-gui"
      - MATRIX_EVAL="CC=clang-10"
  - name: Ubuntu Linux 20.04, Clang 10, GTK 3
    os: linux
    dist: focal
    addons:
      apt:
        packages:
          - clang-10
          - libscrypt-kdf1
          - libscrypt-kdf-dev
          - pylint
    env:
      - CFLAGS="-g -Werror"
      - GTK=libgtk-3-dev
      - TARGETS="pw-cli pw-gui-test-stub pw-gui"
      - MATRIX_EVAL="CC=clang-10"

  - name: macOS, XCode 11.2 Clang
    os: osx
    osx_image: xcode11.2
    addons:
      homebrew:
        update: true
        packages:
          - cunit
          - openssl
    env:
      # XXX: can't enable -Werror because Scrypt build generates some warnings
      - CFLAGS="${CFLAGS} -I/usr/local/opt/openssl/include -I$(brew --prefix)/include -g"
      - LDFLAGS="${LDFLAGS} -L/usr/local/opt/openssl/lib -L$(brew --prefix)/lib"
      - TARGETS="pw-cli pw-gui-test-stub pw-gui"
      - MATRIX_EVAL=
      - PKG_CONFIG_PATH=/usr/local/opt/openssl/lib/pkgconfig

  - name: macOS, XCode 11.3 Clang
    os: osx
    osx_image: xcode11.3
    addons:
      homebrew:
        update: true
        packages:
          - cunit
          - openssl
    env:
      - CFLAGS="${CFLAGS} -I/usr/local/opt/openssl/include -I$(brew --prefix)/include -g"
      - LDFLAGS="${LDFLAGS} -L/usr/local/opt/openssl/lib -L$(brew --prefix)/lib"
      - TARGETS="pw-cli pw-gui-test-stub pw-gui"
      - MATRIX_EVAL=
      - PKG_CONFIG_PATH=/usr/local/opt/openssl/lib/pkgconfig

before_install:
  - if [ "${TRAVIS_OS_NAME}" = "linux" ]; then sudo apt-get -qq update; fi
  - if [ "${TRAVIS_OS_NAME}" = "linux" ]; then sudo apt-get install -y libcunit1-dev libjson-c-dev python3-pexpect ${GTK}; fi
  # No need to install json-c because it comes with XCode
  - if [ "${TRAVIS_OS_NAME}" = "osx"   ]; then pip3 install pexpect; fi
  - eval "${MATRIX_EVAL}"
  # build and install libscrypt-kdf
  - if [ "${TRAVIS_OS_NAME}" = "osx"   ]; then mkdir scrypt-build && cd scrypt-build && curl https://www.tarsnap.com/scrypt/scrypt-1.3.0.tgz -o scrypt-1.3.0.tgz && tar xf scrypt-1.3.0.tgz && cd scrypt-1.3.0 && ./configure --enable-libscrypt-kdf && make && sudo make install && cd ../..; fi

script:
  - if [ "${TRAVIS_OS_NAME}" = "linux" ]; then python3 -m pylint --errors-only ./tests/integration-tests.py; fi && mkdir build && cd build && cmake .. && cmake --build . -- ${TARGETS} passwand-tests && ./passwand-tests && ../tests/integration-tests.py --verbose && sudo env "PATH=$PATH" cmake --build . -- install
